# Docker Compose — Archestra + Onboarding MCP Server
# ═══════════════════════════════════════════════════
# Usage: docker-compose up -d
# Access: http://localhost:3000 (Archestra UI)
#         http://localhost:8080 (Onboarding API for dashboard)
#         http://localhost:8000 (MCP Server SSE for Archestra)

services:
  # ── Archestra Platform ──────────────────────────
  archestra:
    image: archestra/platform:latest
    ports:
      - "9000:9000" # MCP Gateway
      - "3000:3000" # Web UI
    environment:
      - ARCHESTRA_QUICKSTART=true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - archestra-postgres-data:/var/lib/postgresql/data
      - archestra-app-data:/app/data
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000" ]
      interval: 30s
      timeout: 10s
      retries: 5

  # ── Onboarding MCP Server (SSE mode for Archestra Remote MCP) ──
  onboarding-mcp:
    build:
      context: ..
      dockerfile: Dockerfile
    command: [ "python", "server.py", "sse" ]
    ports:
      - "8000:8000"
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_ORG=${GITHUB_ORG:-acme-corp}
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
      - GDRIVE_SERVICE_ACCOUNT_KEY=${GDRIVE_SERVICE_ACCOUNT_KEY:-}
      - ONBOARD_DATA_PATH=/app/data/onboarding.json
    volumes:
      - onboarding-data:/app/data
    restart: unless-stopped

  # ── Onboarding REST API (for dashboard) ──
  onboarding-api:
    build:
      context: ..
      dockerfile: Dockerfile
    command: [ "python", "server.py", "api" ]
    ports:
      - "8080:8080"
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_ORG=${GITHUB_ORG:-acme-corp}
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
      - GDRIVE_SERVICE_ACCOUNT_KEY=${GDRIVE_SERVICE_ACCOUNT_KEY:-}
      - ONBOARD_DATA_PATH=/app/data/onboarding.json
    volumes:
      - onboarding-data:/app/data
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/api/employees" ]
      interval: 15s
      timeout: 5s
      retries: 3

volumes:
  archestra-postgres-data:
  archestra-app-data:
  onboarding-data:
